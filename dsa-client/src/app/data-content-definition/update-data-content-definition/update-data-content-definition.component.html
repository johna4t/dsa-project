<div class="container" *ngIf="dcdForm && dcd">
  <form [formGroup]="dcdForm" (ngSubmit)="onSubmit()">
    <h2>Update data asset details: {{ dcd?.name }}</h2>

    <!-- Main form card -->
    <div class="card p-2">
      <!-- Name -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Name</mat-label>
        <input matInput formControlName="name" required />
        <mat-error *ngIf="dcdForm.get('name')?.hasError('required')">Name is required</mat-error>
      </mat-form-field>

      <!-- Description -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Description</mat-label>
        <input matInput formControlName="description" />
      </mat-form-field>

      <!-- Source system -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Source system</mat-label>
        <input matInput formControlName="sourceSystem" required />
        <mat-error *ngIf="dcdForm.get('sourceSystem')?.hasError('required')">
          Source system is required
        </mat-error>
      </mat-form-field>

      <!-- Content type -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Content type</mat-label>
        <mat-select formControlName="dataContentType">
          <mat-option *ngFor="let key of dataContentTypeKeys" [value]="key">
            {{ dataContentTypeLabels[key] }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Owner email -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Owner email</mat-label>
        <input matInput formControlName="ownerEmail" required />
        <mat-error *ngIf="dcdForm.get('ownerEmail')?.hasError('required')">Email is required</mat-error>
        <mat-error *ngIf="dcdForm.get('ownerEmail')?.hasError('email')">Enter a valid email</mat-error>
      </mat-form-field>

      <!-- Owner name -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Owner name</mat-label>
        <input matInput formControlName="ownerName" />
      </mat-form-field>

      <!-- Retention period -->
      <div class="d-flex gap-2">
        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Retention value</mat-label>
          <input matInput type="number" formControlName="retentionValue" min="1" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-grow-1">
          <mat-label>Retention unit</mat-label>
          <mat-select formControlName="retentionUnit">
            <mat-option value="D">Days</mat-option>
            <mat-option value="W">Weeks</mat-option>
            <mat-option value="M">Months</mat-option>
            <mat-option value="Y">Years</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <!-- GDPR Perspective -->
    <div class="card p-2 mt-3">
      <h3>GDPR Perspective</h3>
      <h4>Applicable to personal data only.</h4>

      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Lawful basis for processing</mat-label>
        <mat-select formControlName="lawfulBasis">
          <mat-option *ngFor="let key of lawfulBasisKeys" [value]="key">
            {{ lawfulBasisLabels[key] }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Special category</mat-label>
        <mat-select formControlName="specialCategory">
          <mat-option *ngFor="let key of specialCategoryDatasKeys" [value]="key">
            {{ specialCategoryDataLabels[key] }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Article 9 condition</mat-label>
        <mat-select formControlName="article9Condition">
          <mat-option *ngFor="let key of article9ConditionKeys" [value]="key">
            {{ article9ConditionLabels[key] }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Data Processing Activities Accordion (parity with UpdateDataProcessor) -->
    <mat-expansion-panel class="mat-elevation-z0 custom-expansion-panel mt-3">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <div class="d-flex align-items-center justify-content-between w-100">
            <h3 class="m-0">Edit data processing activities</h3>
            <button
              mat-flat-button
              color="primary"
              type="button"
              style="margin-right: 8px"
              (click)="createDataProcessingActivity()"
            >
              Add
            </button>
          </div>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <div class="p-2">
        <table mat-table [dataSource]="dataProcessingActivities" class="mat-elevation-z0 w-100">
          <!-- Activity Name -->
          <ng-container matColumnDef="activityName">
            <th mat-header-cell *matHeaderCellDef>Data processing activity</th>
            <td mat-cell *matCellDef="let activity">{{ activity.name }}</td>
          </ng-container>

          <!-- Processor Name (link to view processor) -->
          <ng-container matColumnDef="processorName">
            <th mat-header-cell *matHeaderCellDef>Processor name</th>
            <td mat-cell *matCellDef="let activity">
              <a
                role="button"
                tabindex="0"
                (click)="viewDataProcessor(activity.dataProcessor?.id)"
                (keydown.enter)="viewDataProcessor(activity.dataProcessor?.id)"
                (keydown.space)="viewDataProcessor(activity.dataProcessor?.id)"
                class="link"
                *ngIf="activity.dataProcessor?.id"
              >
                {{ activity.dataProcessor?.name }}
              </a>
              <span *ngIf="!activity.dataProcessor?.id">â€”</span>
            </td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="updateAction">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let activity">
              <button
                mat-flat-button
                color="primary"
                style="margin: 10px"
                (click)="viewDataProcessingActivity(activity.id)"
              >
                View
              </button>
              <button
                mat-flat-button
                color="primary"
                style="margin: 10px"
                (click)="updateDataProcessingActivity(activity.id)"
              >
                Edit
              </button>
              <button
                mat-flat-button
                color="accent"
                style="margin: 10px"
                (click)="deleteDataProcessingActivity(activity.id)"
              >
                Delete
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['activityName', 'processorName', 'updateAction']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['activityName', 'processorName', 'updateAction']"></tr>
        </table>

        <div *ngIf="dataProcessingActivities?.length === 0" class="mt-3 text-muted">
          No data processing activities yet.
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Submit/Cancel Buttons -->
    <div align="right" class="mt-3">
      <button
        mat-flat-button
        color="primary"
        type="submit"
        style="margin: 5px"
        [disabled]="shouldDisableSubmit()"
      >
        Submit
      </button>
      <button mat-flat-button color="accent" style="margin: 5px" (click)="goBack()">Cancel</button>
    </div>
  </form>
</div>
